<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Futterrechner</title>

<style>
body{font-family:Arial;margin:0;background:#eef1f4}
header{background:#2f3b45;color:#fff;padding:12px;text-align:center;font-size:20px}
.tabs{display:flex}
.tab{flex:1;text-align:center;padding:12px;background:#d5dbe0;font-size:17px}
.tab.active{background:#2f3b45;color:#fff}
.panel{padding:10px}

.category{border-radius:12px;margin-bottom:16px;overflow:hidden;box-shadow:0 2px 6px rgba(0,0,0,0.08)}
.cat-header{padding:10px;color:#fff;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
.cat-header h2{margin:0;font-size:18px}
.cat-body{background:#fff;padding:10px}
.category.collapsed .cat-body{display:none}

.cat-kuehe{background:#2f80ed}
.cat-bullen{background:#27ae60}
.cat-trocken{background:#f2a900}

input{font-size:15px;padding:6px}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid #ddd;padding:6px;text-align:right;font-size:14px}
th:first-child,td:first-child{text-align:left}

@media(max-width:600px){
  td:first-child{padding-top:12px;padding-bottom:12px}
  td{font-size:15px}
}

.total{margin-top:6px;padding-top:6px;border-top:2px solid #ccc;font-weight:bold;text-align:right}
.agf{color:#b30000;font-weight:bold}
.mlf{color:#003399;font-weight:bold}
.hidden{display:none}

.summe{
  font-weight:bold;
  background:#f5f7fa;
  border-left:4px solid #2f3b45;
}


/* st√§rkere Gesamtanzeige */
.total{
  background:#2f3b45;
  color:#fff;
  padding:10px;
  border-radius:8px;
  font-size:18px;
}

/* Summe je Kategorie farbig */
.cat-kuehe .summe{border-left-color:#2f80ed;}
.cat-bullen .summe{border-left-color:#27ae60;}
.cat-trocken .summe{border-left-color:#f2a900;}


.kilo-btn{
  margin-left:6px;
  padding:3px 8px;
  font-size:12px;
  border-radius:6px;
  border:1px solid #ccc;
  background:#f0f0f0;
}
.kilo-btn.active{
  background:#2f80ed;
  color:#fff;
  border-color:#2f80ed;
}
.inline-total-input{
  width:90px;
  font-size:16px;
}
</style>

</head>
<body>

<header>üêÑ Futter-Rechner</header>

<div class="tabs">
  <div class="tab active" onclick="showTab('calc')">Rechner</div>
  <div class="tab" onclick="showTab('settings')">Einstellungen</div>
</div>

<div id="calc" class="panel"></div>
<div id="settings" class="panel hidden"></div>

<script>
let globalConfig = JSON.parse(localStorage.getItem("globalConfig_final3")) || {
  agfName:"AGF",
  mlfName:"MLF",
  agfKgPerSec:0.5,
  mlfKgPerSec:0.5
};

const CATS=[
  {id:"kuehe",name:"K√ºhe",cls:"cat-kuehe"},
  {id:"bullen",name:"Bullen",cls:"cat-bullen"},
  {id:"trocken",name:"Trockensteher",cls:"cat-trocken"}
];
const ITEMS=10;

function defItems(){
  let arr=[];
  for(let i=0;i<ITEMS-2;i++) arr.push({name:"Futter "+(i+1),kg:0});
  arr.push({type:"agf",kg:0});
  arr.push({type:"mlf",kg:0});
  return arr;
}

let data=JSON.parse(localStorage.getItem("futter_final_full3"))||{
  kuehe:{anz:100,items:defItems(),collapsed:false},
  bullen:{anz:1,items:defItems(),collapsed:false},
  trocken:{anz:10,items:defItems(),collapsed:false}
};

function showTab(t){
  calc.classList.toggle("hidden",t!=="calc");
  settings.classList.toggle("hidden",t!=="settings");
  document.querySelectorAll(".tab").forEach(e=>e.classList.remove("active"));
  document.querySelector(`.tab[onclick*='${t}']`).classList.add("active");
}

function fmt(sec){
  sec=Math.round(sec);
  return Math.floor(sec/60)+" min "+(sec%60)+" s";
}

function toggleCat(id){
  data[id].collapsed=!data[id].collapsed;
  save();
  buildCalc();
}

function buildCalc(){
  calc.innerHTML="";
  CATS.forEach(c=>{
    let lauf=0,sumKg=0;
    const anz=data[c.id].anz;
    let rows="";

    data[c.id].items.forEach(it=>{
      if(it.kg===0) return;
      const kgGes=it.kg*anz;
      let name=it.name;
      let zeit="-";

      if(it.type==="agf"){
        name=globalConfig.agfName;
        zeit='<span class="agf">'+fmt(kgGes/globalConfig.agfKgPerSec)+'</span>';
      }
      if(it.type==="mlf"){
        name=globalConfig.mlfName;
        zeit='<span class="mlf">'+fmt(kgGes/globalConfig.mlfKgPerSec)+'</span>';
      }

      lauf+=kgGes;
      sumKg+=kgGes;

      rows+=`<tr>
        <td>${name}</td>
        <td>${kgGes.toFixed(1)}</td>
        <td class="summe">${lauf.toFixed(1)}</td>
        <td>${zeit}</td>
      </tr>`;
    });

    if(!rows){
      rows='<tr><td colspan="4" style="text-align:center;color:#888">Keine Futtersorten aktiv</td></tr>';
    }

    calc.innerHTML+=`
    <div class="category ${data[c.id].collapsed?'collapsed':''}">
      <div class="cat-header ${c.cls}" onclick="toggleCat('${c.id}')">
        <h2>${c.name}</h2>
        <span>${data[c.id].collapsed?'‚ñº':'‚ñ≤'}</span>
      </div>

      <div class="cat-body">
        <div style="margin-bottom:6px">
          Anzahl Tiere:
          <input type="text" inputmode="numeric" value="${anz}"
            onfocus="this.select()"
            oninput="data.${c.id}.anz=parseInt(this.value)||0;save()"
            onblur="buildCalc()">
        </div>

        <table>
          <tr><th>Futter</th><th>kg gesamt</th><th>Summe</th><th>Zeit</th></tr>
          ${rows}
        </table>

        <div class="total">Gesamt: ${sumKg.toFixed(1)} kg</div>
      </div>
    </div>`;
  });
}

function buildSettings(){
  settings.innerHTML = `
    <h2>Globale AGF / MLF Einstellungen</h2>
    <div style="background:#fff;padding:10px;border-radius:8px;margin-bottom:16px">
      <label>AGF Name</label><br>
      <input type="text" value="${globalConfig.agfName}"
        onfocus="this.select()"
        oninput="globalConfig.agfName=this.value;saveGlobal()"
        onblur="buildCalc();buildSettings()"><br><br>

      <label>AGF kg / Sekunde</label><br>
      <input type="number" step="0.01" value="${globalConfig.agfKgPerSec}"
        onfocus="this.select()"
        oninput="globalConfig.agfKgPerSec=this.valueAsNumber||0.01;saveGlobal()"
        onblur="buildCalc()"><br><br>

      <label>MLF Name</label><br>
      <input type="text" value="${globalConfig.mlfName}"
        onfocus="this.select()"
        oninput="globalConfig.mlfName=this.value;saveGlobal()"
        onblur="buildCalc();buildSettings()"><br><br>

      <label>MLF kg / Sekunde</label><br>
      <input type="number" step="0.01" value="${globalConfig.mlfKgPerSec}"
        onfocus="this.select()"
        oninput="globalConfig.mlfKgPerSec=this.valueAsNumber||0.01;saveGlobal()"
        onblur="buildCalc()">
    </div>
  `;

  CATS.forEach(c=>{
    settings.innerHTML += `<h2>${c.name}</h2>`;
    data[c.id].items.forEach((it,i)=>{
      if(it.type){
        const label = it.type==="agf" ? globalConfig.agfName : globalConfig.mlfName;
        settings.innerHTML += `
        <div style="background:#fff;padding:6px;margin-bottom:6px;border-radius:6px">
          <strong>${label}</strong>
          <input type="number" step="0.01" value="${it.kg}" onfocus="this.select()"
            oninput="data.${c.id}.items[${i}].kg=this.valueAsNumber||0;buildCalc();save()">
        </div>`;
      } else {
        settings.innerHTML += `
        <div style="background:#fff;padding:6px;margin-bottom:6px;border-radius:6px">
          <input type="text" value="${it.name}" onfocus="this.select()"
            oninput="data.${c.id}.items[${i}].name=this.value;buildCalc();save()">
          <input type="number" step="0.01" value="${it.kg}" onfocus="this.select()"
            oninput="data.${c.id}.items[${i}].kg=this.valueAsNumber||0;buildCalc();save()">
        </div>`;
      }
    });
  });
}

function save(){
  localStorage.setItem("futter_final_full3",JSON.stringify(data));
}
function saveGlobal(){
  localStorage.setItem("globalConfig_final3",JSON.stringify(globalConfig));
}

buildCalc();
buildSettings();

let kiloMode = {};

function toggleKilo(cat){
  kiloMode[cat] = !kiloMode[cat];
  document.querySelectorAll(`[data-kilo-btn="${cat}"]`).forEach(b=>{
    b.classList.toggle("active", kiloMode[cat]);
  });
}

function enableTotalEdit(cat){
  if(!kiloMode[cat]) return;
  const span = document.querySelector(`[data-total="${cat}"]`);
  if(!span || span.querySelector("input")) return;

  const current = span.textContent.trim();
  const input = document.createElement("input");
  input.type = "number";
  input.value = parseFloat(current) || 0;
  input.className = "inline-total-input";

  input.onkeydown = (e)=>{
    if(e.key === "Enter"){
      const newTotal = parseFloat(input.value);
      if(!isNaN(newTotal)){
        applyTotalKg(cat, newTotal);
      }
      span.textContent = newTotal;
    }
  };

  span.textContent = "";
  span.appendChild(input);
  input.focus();
}

function applyTotalKg(cat, totalKg){
  const catData = data[cat];
  if(!catData) return;

  let kgPerAnimal = 0;
  Object.values(catData.feed).forEach(f=>{
    if(f.kg > 0) kgPerAnimal += f.kg;
  });
  if(kgPerAnimal <= 0) return;

  catData.count = Math.round(totalKg / kgPerAnimal);
  saveData();
  render();
}

</script>
</body>
</html>
