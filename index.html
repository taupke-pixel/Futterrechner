<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Futterrechner</title>

<style>
body{font-family:Arial;margin:0;background:#eef1f4}
header{background:#2f3b45;color:#fff;padding:12px;text-align:center;font-size:20px}

.tabs{display:flex}
.tab{flex:1;padding:12px;text-align:center;background:#d5dbe0;cursor:pointer}
.tab.active{background:#2f3b45;color:#fff}

.panel{padding:12px}
.hidden{display:none}

.category{border-radius:12px;margin-bottom:16px;overflow:hidden;box-shadow:0 2px 6px rgba(0,0,0,.1)}
.cat-header{padding:12px;color:#fff;font-weight:bold;cursor:pointer;display:flex;justify-content:space-between}
.cat-body{background:#fff;padding:12px}
.category.collapsed .cat-body{display:none}

.cat-kuehe{background:#2f80ed}
.cat-bullen{background:#27ae60}
.cat-trocken{background:#f2a900}

table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid #ddd;padding:6px;text-align:right}
th:first-child,td:first-child{text-align:left}

.sort-row{
  display:grid;
  grid-template-columns:40px 1fr;
  gap:8px;
  margin-bottom:6px;
}

.total{
  background:#2f3b45;
  color:#fff;
  padding:10px;
  border-radius:8px;
  margin-top:8px;
  display:flex;
  justify-content:space-between;
  align-items:center
}

.agf{color:#b30000;font-weight:bold}
.mlf{color:#003399;font-weight:bold}
</style>
</head>

<body>

<header>üêÑ Futterrechner ‚Äî Stall Version</header>

<div class="tabs">
  <div class="tab active" onclick="showTab('calc')">Rechner</div>
  <div class="tab" onclick="showTab('settings')">Einstellungen</div>
</div>

<div id="calc" class="panel"></div>
<div id="settings" class="panel hidden"></div>

<script>

/* ===== SAFE STORAGE ===== */
function safeLoad(key, fallback){
  try{
    const d = JSON.parse(localStorage.getItem(key));
    return d ?? fallback;
  }catch{
    return fallback;
  }
}

function safeSave(key, val){
  localStorage.setItem(key, JSON.stringify(val));
}

/* ===== GLOBAL CONFIG ===== */
let globalCfg = safeLoad("gCfg", {
  agfName:"AGF",
  mlfName:"MLF",
  agfKg:0.5,
  mlfKg:0.5
});

/* ===== CATEGORIES ===== */
const CATS=[
  {id:"kuehe",name:"K√ºhe",cls:"cat-kuehe"},
  {id:"bullen",name:"Bullen",cls:"cat-bullen"},
  {id:"trocken",name:"Trockensteher",cls:"cat-trocken"}
];

/* ===== DEFAULT ITEMS ===== */
function defItems(){
  let a=[];
  for(let i=1;i<=8;i++) a.push({name:"Futter "+i,kg:0});
  a.push({type:"agf",kg:0});
  a.push({type:"mlf",kg:0});
  return a;
}

/* ===== DATA ===== */
let data = safeLoad("futter", {
  kuehe:{anz:100,items:defItems(),collapsed:false},
  bullen:{anz:10,items:defItems(),collapsed:false},
  trocken:{anz:5,items:defItems(),collapsed:false}
});

/* ===== TIME FORMAT ===== */
function fmt(sec){
  sec=Math.round(sec);
  return Math.floor(sec/60)+" min "+(sec%60)+" s";
}

/* ===== SAVE ===== */
function save(){
  safeSave("futter", data);
}
function saveGlobal(){
  safeSave("gCfg", globalCfg);
}

/* ===== TABS ===== */
function showTab(t){
  ["calc","settings"].forEach(id=>{
    document.getElementById(id).classList.toggle("hidden", id!==t);
  });
  document.querySelectorAll(".tab").forEach(e=>e.classList.remove("active"));
  document.querySelector(`.tab[onclick*='${t}']`).classList.add("active");
}

/* ===== RECHNER ===== */
function buildCalc(){
  calc.innerHTML="";

  CATS.forEach(c=>{
    let rows="";
    let sum=0,lauf=0;

    data[c.id].items.forEach(it=>{
      if(it.kg<=0) return;

      let name = it.type==="agf"
        ? globalCfg.agfName
        : it.type==="mlf"
        ? globalCfg.mlfName
        : it.name;

      let g = it.kg * data[c.id].anz;
      let zeit="-";

      if(it.type==="agf") zeit=`<span class="agf">${fmt(g/globalCfg.agfKg)}</span>`;
      if(it.type==="mlf") zeit=`<span class="mlf">${fmt(g/globalCfg.mlfKg)}</span>`;

      lauf+=g; sum+=g;

      rows += `
      <tr>
        <td>${name}</td>
        <td>${g.toFixed(1)}</td>
        <td>${lauf.toFixed(1)}</td>
        <td>${zeit}</td>
      </tr>`;
    });

    calc.innerHTML += `
    <div class="category ${data[c.id].collapsed?'collapsed':''}">
      <div class="cat-header ${c.cls}"
        onclick="data.${c.id}.collapsed=!data.${c.id}.collapsed; save(); buildCalc();">
        ${c.name}
        <span>${data[c.id].collapsed?'‚ñº':'‚ñ≤'}</span>
      </div>

      <div class="cat-body">
        Tiere:
        <input type="number" value="${data[c.id].anz}"
          oninput="data.${c.id}.anz=this.valueAsNumber||0; save();"
          onblur="buildCalc();">

        <table>
          <tr><th>Futter</th><th>kg</th><th>Summe</th><th>Zeit</th></tr>
          ${rows || "<tr><td colspan=4>‚Äì</td></tr>"}
        </table>

        <div class="total">
          Gesamt: ${sum.toFixed(1)} kg
        </div>
      </div>
    </div>`;
  });
}

/* ===== EINSTELLUNGEN ===== */
function buildSettings(){
  settings.innerHTML = `
  <h3>AGF / MLF</h3>

  AGF Name 
  <input value="${globalCfg.agfName}"
    oninput="globalCfg.agfName=this.value; saveGlobal(); buildCalc(); buildSettings();"><br>

  MLF Name 
  <input value="${globalCfg.mlfName}"
    oninput="globalCfg.mlfName=this.value; saveGlobal(); buildCalc(); buildSettings();">

  <hr>
  `;

  CATS.forEach(c=>{
    settings.innerHTML += `<h3>${c.name}</h3>`;

    data[c.id].items.forEach((it,i)=>{
      let displayName =
        it.type==="agf" ? globalCfg.agfName :
        it.type==="mlf" ? globalCfg.mlfName :
        it.name;

      settings.innerHTML += `
      <div class="sort-row">
        <div></div>
        <div>
          <input type="text" value="${displayName}"
            oninput="
              if('${it.type}'==='agf'){ globalCfg.agfName=this.value; saveGlobal(); }
              else if('${it.type}'==='mlf'){ globalCfg.mlfName=this.value; saveGlobal(); }
              else { data['${c.id}'].items[${i}].name=this.value; save(); }
              buildCalc();
            ">

          <input type="number" value="${it.kg}"
            oninput="data['${c.id}'].items[${i}].kg=this.valueAsNumber||0; save(); buildCalc();">
        </div>
      </div>`;
    });
  });
}

/* ===== INIT ===== */
buildCalc();
buildSettings();

</script>
</body>
</html>
