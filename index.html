<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Futterrechner</title>

<style>
body{font-family:Arial;margin:0;background:#eef1f4}
header{background:#2f3b45;color:#fff;padding:12px;text-align:center;font-size:20px}
.tabs{display:flex}
.tab{flex:1;padding:12px;text-align:center;background:#d5dbe0;cursor:pointer}
.tab.active{background:#2f3b45;color:#fff}
.panel{padding:12px}
.hidden{display:none}
.category{border-radius:12px;margin-bottom:16px;overflow:hidden;box-shadow:0 2px 6px rgba(0,0,0,.1)}
.cat-header{padding:12px;color:#fff;font-weight:bold;cursor:pointer;display:flex;justify-content:space-between}
.cat-body{background:#fff;padding:12px}
.category.collapsed .cat-body{display:none}
.cat-kuehe{background:#2f80ed}
.cat-bullen{background:#27ae60}
.cat-trocken{background:#f2a900}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid #ddd;padding:6px;text-align:right}
th:first-child,td:first-child{text-align:left}
.total{background:#2f3b45;color:#fff;padding:10px;border-radius:8px;margin-top:8px;display:flex;justify-content:space-between;align-items:center}
.kilo-btn{padding:6px 12px;border-radius:6px;border:none;background:#ccc;cursor:pointer}
.kilo-btn.active{background:#2f80ed;color:#fff}
.inline-total-input{width:120px;font-size:16px}
.agf{color:#b30000;font-weight:bold}
.mlf{color:#003399;font-weight:bold}
.calc-box{max-width:360px;margin:auto;background:#fff;padding:12px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.15)}
.calc-display{background:#eef1f4;padding:12px;font-size:24px;text-align:right;border-radius:6px;margin-bottom:10px}
.calc-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.calc-btn{padding:16px;font-size:18px;border:none;border-radius:8px;background:#d5dbe0;cursor:pointer}
.calc-btn.op{background:#2f80ed;color:#fff}
.calc-btn.eq{background:#27ae60;color:#fff}
.calc-btn.clear{background:#b30000;color:#fff}
.calc-history{margin-top:12px;font-size:14px;background:#f5f7fa;padding:8px;border-radius:6px;max-height:160px;overflow:auto}
</style>
</head>
<body>

<header>ğŸ„ Futterrechner</header>

<div class="tabs">
  <div class="tab active" data-tab="calc">Rechner</div>
  <div class="tab" data-tab="settings">Einstellungen</div>
  <div class="tab" data-tab="calc2">Taschenrechner</div>
</div>

<div id="calc" class="panel"></div>
<div id="settings" class="panel hidden"></div>
<div id="calc2" class="panel hidden"></div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Hilfsfunktionen
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function escapeHtml(str) {
  return (str + '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'})[m]);
}

function fmt(sec) {
  sec = Math.round(sec);
  return Math.floor(sec/60) + " min " + (sec % 60) + " s";
}

const debounce = (fn, ms) => {
  let t;
  return (...args) => {
    clearTimeout(t);
    t = setTimeout(() => fn(...args), ms);
  };
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Daten
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let globalCfg = JSON.parse(localStorage.getItem("gCfg")) || {
  agfName: "AGF",
  mlfName: "MLF",
  agfKg: 0.5,
  mlfKg: 0.5
};

const CATS = [
  {id: "kuehe",   name: "KÃ¼he",         cls: "cat-kuehe"},
  {id: "bullen",  name: "Bullen",       cls: "cat-bullen"},
  {id: "trocken", name: "Trockensteher", cls: "cat-trocken"}
];

function defItems() {
  let a = [];
  for (let i = 1; i <= 8; i++) a.push({name: "Futter " + i, kg: 0});
  a.push({type: "agf", kg: 0});
  a.push({type: "mlf", kg: 0});
  return a;
}

let data = JSON.parse(localStorage.getItem("futter")) || {
  kuehe:   {anz: 100, items: defItems(), collapsed: false},
  bullen:  {anz: 10,  items: defItems(), collapsed: false},
  trocken: {anz: 5,   items: defItems(), collapsed: false}
};

let sortMode = false;
let kiloMode = {};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Tabs
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showTab(tabId) {
  document.querySelectorAll(".panel").forEach(p => p.classList.toggle("hidden", p.id !== tabId));
  document.querySelectorAll(".tab").forEach(t => t.classList.toggle("active", t.dataset.tab === tabId));
}

document.querySelectorAll(".tab").forEach(tab => {
  tab.addEventListener("click", () => showTab(tab.dataset.tab));
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Taschenrechner (sichere Variante â€“ nur einfache Rechenzeichen)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let expr = "";
let history = JSON.parse(localStorage.getItem("calcHist")) || [];

function safeCalc(str) {
  if (!/^[0-9.+\-*/() ]*$/.test(str)) return "Error";
  try {
    return Function('"use strict";return (' + str + ')')();
  } catch {
    return "Error";
  }
}

function press(v) {
  if (v === "C") {
    expr = "";
  } else if (v === "=") {
    const result = safeCalc(expr);
    if (result !== "Error") {
      history.unshift(expr + " = " + result);
      history = history.slice(0, 20);
      localStorage.setItem("calcHist", JSON.stringify(history));
      expr = String(result);
    } else {
      expr = "Error";
    }
  } else {
    expr += v;
  }
  document.getElementById("disp").textContent = expr || "0";
  document.getElementById("hist").innerHTML = history.map(h => "<div>" + escapeHtml(h) + "</div>").join("");
}

function buildCalc2() {
  const calc2 = document.getElementById("calc2");
  calc2.innerHTML = `
    <div class="calc-box">
      <div id="disp" class="calc-display">0</div>
      <div class="calc-grid">
        ${["7","8","9","/","4","5","6","*","1","2","3","-","C","0","=","+"]
          .map(v => `<button class="calc-btn ${v==="="? "eq" : "+-*/".includes(v)? "op" : v==="C"? "clear" : ""}"
            data-value="\( {v}"> \){v}</button>`).join("")}
      </div>
      <div id="hist" class="calc-history"></div>
    </div>`;

  document.querySelectorAll("#calc2 button").forEach(btn => {
    btn.addEventListener("click", () => press(btn.dataset.value));
  });
  document.getElementById("hist").innerHTML = history.map(h => "<div>" + escapeHtml(h) + "</div>").join("");
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Haupt-Rechner
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const debouncedBuildCalc = debounce(buildCalc, 250);

function buildCalc() {
  const container = document.getElementById("calc");
  container.innerHTML = "";

  CATS.forEach(cat => {
    const catData = data[cat.id];
    let sum = 0, lauf = 0;
    let rows = "";

    catData.items.forEach(item => {
      if (item.kg <= 0) return;
      const g = item.kg * catData.anz;
      const name = item.type === "agf" ? globalCfg.agfName :
                   item.type === "mlf" ? globalCfg.mlfName :
                   item.name;
      let zeit = "-";
      if (item.type === "agf") zeit = `<span class="agf">${fmt(g / globalCfg.agfKg)}</span>`;
      if (item.type === "mlf") zeit = `<span class="mlf">${fmt(g / globalCfg.mlfKg)}</span>`;

      lauf += g;
      sum += g;

      rows += `
        <tr>
          <td>${escapeHtml(name)}</td>
          <td>${g.toFixed(1)}</td>
          <td>${lauf.toFixed(1)}</td>
          <td>${zeit}</td>
        </tr>`;
    });

    const section = document.createElement("div");
    section.className = "category" + (catData.collapsed ? " collapsed" : "");
    section.innerHTML = `
      <div class="cat-header ${cat.cls}">
        \( {cat.name}<span> \){catData.collapsed ? 'â–¼' : 'â–²'}</span>
      </div>
      <div class="cat-body">
        Tiere: <input type="number" value="\( {catData.anz}" min="0" class="anz-input" data-cat=" \){cat.id}">
        <table>
          <tr><th>Futter</th><th>kg</th><th>Summe</th><th>Zeit</th></tr>
          ${rows || "<tr><td colspan=4>â€“</td></tr>"}
        </table>
        <div class="total">
          <span class="total-span" data-cat="${cat.id}">Gesamt: ${sum.toFixed(1)} kg</span>
          <button class="kilo-btn \( {kiloMode[cat.id] ? 'active' : ''}" data-cat=" \){cat.id}">kilo</button>
        </div>
      </div>`;

    section.querySelector(".cat-header").addEventListener("click", () => {
      catData.collapsed = !catData.collapsed;
      save();
      buildCalc();
    });

    section.querySelector(".anz-input").addEventListener("input", e => {
      catData.anz = Number(e.target.value) || 0;
      save();
      debouncedBuildCalc();
    });

    section.querySelector(".kilo-btn").addEventListener("click", e => {
      const c = e.target.dataset.cat;
      kiloMode[c] = !kiloMode[c];
      e.target.classList.toggle("active", kiloMode[c]);
      if (!kiloMode[c]) debouncedBuildCalc();
    });

    section.querySelector(".total-span").addEventListener("click", e => {
      const c = e.target.dataset.cat;
      if (!kiloMode[c]) return;
      const current = parseFloat(e.target.dataset.val) || 0;
      e.target.innerHTML = `<input type="number" class="inline-total-input" value="\( {current}" data-cat=" \){c}"> kg`;
      const inp = e.target.querySelector("input");
      inp.focus();
      inp.select();
      inp.addEventListener("blur", () => {
        const kg = Number(inp.value) || 0;
        let portion = 0;
        data[c].items.forEach(i => portion += i.kg);
        if (portion > 0) {
          data[c].anz = Math.round(kg / portion);
          save();
          buildCalc();
        }
      }, {once: true});
    });

    container.appendChild(section);
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Einstellungen
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildSettings() {
  const container = document.getElementById("settings");
  let html = `
    <h3>Sortierung</h3>
    <button id="sort-toggle">${sortMode ? 'Sortieren beenden' : 'Sortieren aktivieren'}</button>
    <hr>

    <h3>AGF / MLF</h3>
    AGF Name <input type="text" id="agf-name" value="${escapeHtml(globalCfg.agfName)}"><br>
    kg/s <input type="number" step="0.1" id="agf-kg" value="${globalCfg.agfKg}"><br><br>

    MLF Name <input type="text" id="mlf-name" value="${escapeHtml(globalCfg.mlfName)}"><br>
    kg/s <input type="number" step="0.1" id="mlf-kg" value="${globalCfg.mlfKg}"><hr>
  `;

  CATS.forEach(cat => {
    html += `<h3>\( {cat.name}</h3><div class="cat-items" data-cat=" \){cat.id}"></div>`;
  });

  container.innerHTML = html;

  // Event-Listener fÃ¼r globale Felder
  document.getElementById("sort-toggle").addEventListener("click", () => {
    sortMode = !sortMode;
    buildSettings();
  });

  ["agf-name","agf-kg","mlf-name","mlf-kg"].forEach(id => {
    const el = document.getElementById(id);
    el.addEventListener("input", () => {
      if (id === "agf-name") globalCfg.agfName = el.value;
      if (id === "mlf-name") globalCfg.mlfName = el.value;
      if (id === "agf-kg") globalCfg.agfKg = Number(el.value) || 0.01;
      if (id === "mlf-kg") globalCfg.mlfKg = Number(el.value) || 0.01;
      saveGlobal();
      debouncedBuildCalc();
    });
  });

  // Items rendern
  CATS.forEach(cat => {
    const parent = container.querySelector(`.cat-items[data-cat="${cat.id}"]`);
    data[cat.id].items.forEach((item, idx) => {
      const name = item.type === "agf" ? globalCfg.agfName :
                   item.type === "mlf" ? globalCfg.mlfName :
                   item.name;

      const row = document.createElement("div");
      row.style.display = "flex";
      row.style.gap = "8px";
      row.style.marginBottom = "6px";
      row.innerHTML = `
        ${sortMode ? `
          <div style="display:flex;flex-direction:column;gap:2px;">
            <button data-cat="\( {cat.id}" data-idx=" \){idx}" data-dir="-1">â–²</button>
            <button data-cat="\( {cat.id}" data-idx=" \){idx}" data-dir="1">â–¼</button>
          </div>` : '<div style="width:40px"></div>'}
        <div style="flex:1">
          <input type="text" value="\( {escapeHtml(name)}" data-cat=" \){cat.id}" data-idx="\( {idx}" data-type=" \){item.type || 'name'}">
          <input type="number" step="0.1" value="\( {item.kg}" data-cat=" \){cat.id}" data-idx="${idx}" data-type="kg">
        </div>`;

      parent.appendChild(row);
    });
  });

  // Sortier-Buttons
  container.querySelectorAll("button[data-dir]").forEach(btn => {
    btn.addEventListener("click", e => {
      const c = e.target.dataset.cat;
      const i = Number(e.target.dataset.idx);
      const d = Number(e.target.dataset.dir);
      const arr = data[c].items;
      const ni = i + d;
      if (ni < 0 || ni >= arr.length) return;
      [arr[i], arr[ni]] = [arr[ni], arr[i]];
      save();
      buildSettings();
      debouncedBuildCalc();
    });
  });

  // Item-Eingaben
  container.querySelectorAll("input[data-type]").forEach(inp => {
    inp.addEventListener("input", e => {
      const c = e.target.dataset.cat;
      const i = Number(e.target.dataset.idx);
      const item = data[c].items[i];
      if (e.target.dataset.type === "kg") {
        item.kg = Number(e.target.value) || 0;
      } else if (item.type) {
        if (item.type === "agf") globalCfg.agfName = e.target.value;
        if (item.type === "mlf") globalCfg.mlfName = e.target.value;
        saveGlobal();
      } else {
        item.name = e.target.value;
      }
      save();
      debouncedBuildCalc();
    });
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Speichern
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function save() {
  localStorage.setItem("futter", JSON.stringify(data));
}
function saveGlobal() {
  localStorage.setItem("gCfg", JSON.stringify(globalCfg));
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Start
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
buildCalc();
buildSettings();
buildCalc2();
showTab("calc");
</script>
</body>
</html>
